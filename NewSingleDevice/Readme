Rebuilt most of function construction
